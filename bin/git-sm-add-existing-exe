#!/usr/bin/env sh

# Git subcommand to register an existing Git repository in the tree as a
# submodule.

set -eu

usage() {
    cat <<EOF
git sm-add-existing-exe [-h|--help] SUBMODULE
Perform 'git submodule add' on the existing Git repository SUBMODULE, setting
the tracking branch to master on the remote repository at the location of the
origin remote within SUBMODULE.
EOF
}

# no need for anything so sophisticated as getopts. Furthermore, I like to be
# able to put -h after positional arguments.
reading_arguments='true'
for arg; do
    if [ "$reading_arguments" = "true" ]; then
        shift
        case "$arg" in
            "-h"|"--help")
                usage;
                exit 0;
                ;;
            "--")
                reading_arguments=false;
                ;;
            "-"*)
                >&2 echo "unrecognised option: $arg";
                >&2 usage;
                exit 1;
                ;;
            *)
                set -- "$@" "$arg"
                ;;
        esac
    fi
done

for sm; do
    git submodule add -b master \
        "$(cd -- "$sm";
        git --git-dir=.git --work-tree=. remote get-url origin)" "$sm"
done

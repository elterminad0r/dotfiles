#!/usr/bin/env sh

# grep for a given pattern in file _names_, opening any matches in $EDITOR or
# vim.

set -eu

usage() {
    cat <<EOF
grepvim [-h|--help] FILENAME_PATTERN FILE [FILE...]
Search for the regular expression FILENAME_PATTERN in the names of given FILES.

Open any files with a matching name in \$EDITOR or vim.
EOF
}

# no need for anything so sophisticated as getopts. Furthermore, I like to be
# able to put -h after positional arguments.
for arg; do
    case "$arg" in
        "-h"|"--help")
            usage;
            exit 0;
            ;;
        "--")
            break;
            ;;
        "-"*)
            >&2 echo "unrecognised option: $arg";
            >&2 usage;
            exit 1;
            ;;
        *)
            ;;
    esac
done

if [ "$#" -le "1" ]; then
    >&2 echo "need files - did you want vimack?"
    >&2 usage
    exit 1
fi

pattern="$1"
shift

if grep --version | head -n 1 | grep -q GNU; then
    grepflags=-zZ
    xargsflags=-0
    printfsep='\0'
else
    >&2 echo "warning: grep not safe on newlines: hit Enter to continue"
    read -r
    grepflags=
    xargsflags=-d'\n'
    printfsep='\n'
fi

tmp_templ="/tmp/grepvim/$USER.$PWD.$(date '+%Y%m%d%H%M%S').XXXXXXXX"
mkdir -p "$(dirname "$tmp_templ")"
file_dump="$(mktemp "$tmp_templ")"

# wacky quoting on purpose, so empty variables are ignored
printf "%s$printfsep" "$@" | \
    grep -i $grepflags "$pattern" | \
    tee "$file_dump" | \
    vim-stdin $xargsflags

echo "opened files"
< "$file_dump" xargs $xargsflags printf '%q\n'
